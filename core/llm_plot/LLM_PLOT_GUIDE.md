# LLM 智能绘图工具 - Dify 插件版本

## 概述

这是一个为 Dify 平台设计的 LLM 智能绘图工具，能够根据用户的自然语言问题和数据，自动生成合适的图表。工具采用 Dify 插件标准格式，支持在 Dify 工作流中seamless集成。

## 功能特性

- 🤖 **智能分析**: 使用 LLM 理解用户问题，自动选择最合适的图表类型
- 📊 **多图表支持**: 支持柱状图、折线图、饼图、散点图、直方图
- 🔄 **降级方案**: 当 LLM 分析失败时，提供自动降级方案
- 📝 **流式响应**: 支持 Dify 的流式消息显示
- 🎨 **美观样式**: 现代化的图表样式设计
- ⚡ **高性能**: 优化的参数验证和错误处理

## 参数说明

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `user_question` | string | ✅ | 用户问题描述，如"显示销售趋势变化" |
| `data` | string | ✅ | 要可视化的数据，支持 JSON 格式 |
| `llm` | model | ✅ | LLM 模型配置 |
| `context` | string | ❌ | 额外上下文信息 |
| `use_simple` | boolean | ❌ | 是否使用简化提示（默认 false） |

## 使用示例

### 1. 在 Dify 工作流中使用

```yaml
# 工作流节点配置示例
- name: 生成销售图表
  type: tool
  tool: llm_plot
  inputs:
    user_question: "请显示最近四个季度的销售额变化"
    data: |
      [
        {"quarter": "Q1", "sales": 150},
        {"quarter": "Q2", "sales": 180},
        {"quarter": "Q3", "sales": 165},
        {"quarter": "Q4", "sales": 200}
      ]
    llm: "${llm_model}"
    context: "这是公司季度销售报告"
```

### 2. 支持的数据格式

#### JSON 对象列表
```json
[
  {"month": "1月", "sales": 100, "profit": 20},
  {"month": "2月", "sales": 120, "profit": 25},
  {"month": "3月", "sales": 110, "profit": 22}
]
```

#### 简单键值对
```json
{
  "产品A": 35.2,
  "产品B": 28.7,
  "产品C": 22.1,
  "其他": 14.0
}
```

### 3. 常见用法示例

#### 销售趋势分析
```
用户问题: "显示过去6个月的销售趋势"
数据: [{"month": "7月", "sales": 100}, ...]
期望结果: 折线图
```

#### 市场份额对比
```
用户问题: "比较各产品的市场份额"
数据: [{"product": "A", "share": 35.2}, ...]
期望结果: 饼图
```

#### 性能指标对比
```
用户问题: "对比各部门的业绩"
数据: [{"department": "销售", "performance": 85}, ...]
期望结果: 柱状图
```

## 输出结果

工具执行成功后会返回包含以下信息的流式消息：

1. **状态消息**: 
   - "🎨 正在分析数据并生成图表配置..."
   - "📊 正在生成图表..."

2. **成功消息**:
   - "✅ 成功生成[图表类型]"
   - "📁 图表保存路径: [文件路径]"
   - "📈 图表文件大小: [大小]"

3. **错误处理**:
   - "❌ [具体错误信息]"
   - "🔄 使用降级方案生成图表: [路径]"

## 配置说明

### 工具配置 (llm_plot.yaml)

工具的配置文件定义了输入参数、描述信息和表单类型。主要配置项：

- **identity**: 工具身份信息
- **description**: 多语言描述
- **parameters**: 输入参数定义

### 环境配置

工具支持通过 credentials 配置输出目录：

```yaml
credentials:
  output_dir: "output/charts"  # 图表输出目录
```

## 技术实现

### 架构设计

```
用户输入 → 参数验证 → LLM 分析 → 配置生成 → 图表渲染 → 结果返回
    ↓           ↓          ↓         ↓          ↓         ↓
  问题+数据   格式检查   智能提示   JSON配置   Matplotlib  文件路径
```

### 核心流程

1. **参数验证**: 检查必填参数和数据格式
2. **数据预处理**: 解析 JSON 数据，处理各种格式
3. **Prompt 生成**: 创建智能化的 LLM 提示
4. **LLM 调用**: 使用 Dify 的 LLM 接口获取图表配置
5. **配置解析**: 清理和验证 LLM 返回的 JSON 配置
6. **图表生成**: 使用 Matplotlib 生成美观的图表
7. **结果处理**: 返回文件路径和相关信息

### 错误处理和降级

- **配置验证失败**: 提供详细的错误信息
- **LLM 调用失败**: 尝试使用简单的默认配置
- **图表生成失败**: 提供数据表格等替代方案

## 最佳实践

### 1. 问题描述

- ✅ **好的问题**: "显示最近6个月的销售趋势变化"
- ❌ **差的问题**: "图表"

### 2. 数据格式

- ✅ **推荐**: 结构化的 JSON 数据
- ✅ **支持**: 键值对形式的数据
- ❌ **不推荐**: 纯文本或非结构化数据

### 3. 性能优化

- 使用 `use_simple=true` 处理简单数据
- 限制数据大小在合理范围内
- 提供清晰的问题描述

### 4. 错误处理

- 检查数据格式的有效性
- 提供足够的上下文信息
- 处理网络和服务异常

## 故障排除

### 常见问题

1. **"参数错误: 缺少用户问题描述"**
   - 检查 `user_question` 参数是否提供
   - 确保问题描述不为空

2. **"JSON 解析错误"**
   - 检查 `data` 参数的 JSON 格式
   - 确保 JSON 语法正确

3. **"图表配置验证失败"**
   - LLM 返回的配置不符合规范
   - 尝试使用 `use_simple=true`

4. **"图表生成失败"**
   - 检查输出目录权限
   - 确保 matplotlib 依赖正确安装

### 调试方法

1. **启用详细日志**:
   ```python
   import logging
   logging.basicConfig(level=logging.DEBUG)
   ```

2. **检查 LLM 响应**:
   查看工具返回的状态消息，了解 LLM 分析结果

3. **使用测试数据**:
   先用简单的测试数据验证工具功能

## 版本兼容性

- **Dify**: 0.6.0+
- **Python**: 3.8+
- **依赖**: matplotlib, pydantic, numpy

## 更新日志

### v1.0.0
- 初始版本发布
- 支持5种基本图表类型
- 集成 Dify 插件框架
- 实现智能 LLM 分析
- 添加降级方案支持
